name: Sync releases to adamlui/js-utils

on:
  release:
    types: [published, edited, released]

jobs:
  sync-release:
    name: Sync release to adamlui/js-utils
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      REPO_SYNC_PAT: ${{ secrets.REPO_SYNC_PAT }}
    steps:
      - name: Sync release to adamlui/js-utils
        shell: bash
        run: |
          set -euo pipefail

          # Basic release info
          RELEASE_TITLE="${{ github.event.release.name }}"
          release_tag_name="${{ github.event.release.tag_name }}"
          echo "Release Title: $RELEASE_TITLE"
          echo "Release Tag: $release_tag_name"

          # Fetch release JSON
          this_release="$(curl -fsSL \
            "https://api.github.com/repos/adamlui/scss-to-css/releases/tags/$release_tag_name")"

          RELEASE_NOTES="$(printf '%s' "$this_release" | sed -nE 's/.*"body":[[:space:]]*"(.*)".*/\1/p')"
          if [[ "$RELEASE_NOTES" == *"Auto-synced from"* ]] ; then
            echo "Release already auto-synced. Exiting." ; exit 0 ; fi
          RELEASE_NOTES="$(printf '%s' "$RELEASE_NOTES" | \
            sed 's|ðŸ“ƒ|:page_with_curl:|g; s|ðŸš€|:rocket:|g; s|ðŸ§ |:brain:|g' | \
            sed -E 's|(https://github\.com/adamlui/scss-to-css/tree/)([^"]+)|\
          https://github.com/adamlui/js-utils/tree/\2/scss-to-css|g')"
          TARGET_RELEASE_TAG_NAME="scss-to-css-${release_tag_name#v}"
          echo "Target Tag: $TARGET_RELEASE_TAG_NAME"

          # Check if target release exists
          release_check_resp="$(curl -fsSL \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/adamlui/js-utils/releases/tags/$TARGET_RELEASE_TAG_NAME" || true)"
          if echo "$release_check_resp" | grep -q '"id"'; then
            RELEASE_EXISTS=true
            TARGET_RELEASE_ID="$(echo "$release_check_resp" \
              | grep -o '"id":[[:space:]]*[0-9]\+' \
              | head -1 | grep -o '[0-9]\+')"
            echo "Release exists in js-utils (ID: $TARGET_RELEASE_ID)"
          else
            RELEASE_EXISTS=false
            echo "Release does not exist in js-utils"
          fi

          # Download assets
          download_urls="$(printf '%s' "$this_release" \
            | grep -o '"browser_download_url":[[:space:]]*"[^"]*"' \
            | cut -d '"' -f 4)"
          for url in $download_urls ; do
            echo "Downloading $(basename "$url")"
            curl -fsSLO "$url"
          done

          # Add sync footer
          RELEASE_NOTES+="\n\n###### _Auto-synced from https://github.com/adamlui/scss-to-css/releases"
          RELEASE_NOTES+=" by [kudo-sync-bot](https://github.com/kudo-sync-bot)_"

          # Create or update release
          if [ "$RELEASE_EXISTS" = false ] ; then
            echo "Creating release in js-utils..."

            create_release_payload="$(printf \
              '{"tag_name":"%s","name":"%s","body":"%s"}' \
              "$TARGET_RELEASE_TAG_NAME" "$RELEASE_TITLE" "$RELEASE_NOTES")"

            create_release_response="$(curl -fsSL -X POST \
              -H "Authorization: token $REPO_SYNC_PAT" \
              -H "Content-Type: application/json" \
              -d "$create_release_payload" \
              https://api.github.com/repos/adamlui/js-utils/releases)"

            upload_url="$(printf '%s' "$create_release_response" \
              | sed -nE 's/.*"upload_url":[[:space:]]*"([^"]+)".*/\1/p' \
              | sed 's|{.*}||')"
          else
            echo "Updating existing release..."

            update_release_payload="$(printf \
              '{"name":"%s","body":"%s"}' \
              "$RELEASE_TITLE" "$RELEASE_NOTES")"

            curl -fsSL -X PATCH \
              -H "Authorization: token $REPO_SYNC_PAT" \
              -H "Content-Type: application/json" \
              -d "$update_release_payload" \
              "https://api.github.com/repos/adamlui/js-utils/releases/$TARGET_RELEASE_ID" \
              > /dev/null

            upload_url="$(printf '%s' "$release_check_resp" \
              | sed -nE 's/.*"upload_url":[[:space:]]*"([^"]+)".*/\1/p' \
              | sed 's|{.*}||')"
          fi

          # Upload assets
          if [ -n "$upload_url" ]; then
            echo "Uploading assets..."
            for url in $download_urls; do
              file="$(basename "$url")"
              echo "Uploading $file"
              curl -fsSL --data-binary @"$file" \
                -H "Authorization: token $REPO_SYNC_PAT" \
                -H "Content-Type: application/octet-stream" \
                "$upload_url?name=$file" \
                > /dev/null
            done
          else
            echo "WARNING: upload_url missing, skipping assets"
          fi

          echo "âœ… Release synced to adamlui/js-utils as $TARGET_RELEASE_TAG_NAME"
